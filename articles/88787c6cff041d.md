---
title: "Django REST framework ã§ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£"
emoji: "ğŸ“"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["python", "cleanarchitecture", "django", "djangorestframework", "ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£", "ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£"]
published: false
---

# ã¯ã˜ã‚ã«
ã€€ä»¥å‰åƒã„ã¦ã„ãŸè·å ´ã§ï¼ŒDjango REST framework ã‚’ç”¨ã„ãŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’å®Ÿè·µã—ã¦ã„ãŸã®ã§ï¼Œä»Šå›ã¯ãã‚Œã«ã¤ã„ã¦ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ï¼åˆã‚ã¦ã®æŠ€è¡“è¨˜äº‹æŠ•ç¨¿ãªã®ã§ï¼Œè‡³ã‚‰ãªã„ã¨ã“ã‚ãŒã‚ã‚Œã°ã”æŒ‡æ‘˜ã„ãŸã ã‘ã‚Œã°å¹¸ã„ã§ã™ï¼

ã€€â€» ãªãŠï¼Œæ™‚é–“ã®éƒ½åˆä¸Šã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨è¨€ã£ã¦ã‚‚è‹¥å¹²å´©ã‚ŒãŸã‚‚ã®ã«ãªã£ã¦ãŠã‚Šï¼Œã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ã‚»ã‚ªãƒªãƒ¼ã«ç…§ã‚‰ã—ã¦å¤‰æ›´ã—ãŸç‚¹ãŒã„ãã¤ã‹ã‚ã‚Šã¾ã™ï¼

:::message
æœ¬è¨˜äº‹ã§ç´¹ä»‹ã—ã¦ã„ã‚‹ (å´©ã‚ŒãŸ) ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ã¯ä»¥ä¸‹ãŒã‚ã‚Šã¾ã™ã®ã§ï¼Œè©³ç´°ãŒçŸ¥ã‚ŠãŸã„æ–¹ã¯ãã¡ã‚‰ã‚‚åˆã‚ã›ã¦ã”å‚ç…§ãã ã•ã„ï¼
ã€€
https://github.com/asSqr/dorapi
:::

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ã¯
ã€€ã•ã¦ï¼Œã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ã¯ä½•ã§ã—ã‚‡ã†ã‹ï¼Ÿ ã‚ˆãå¼•ç”¨ã•ã‚Œã‚‹ã®ã¯æ¬¡å›³ã§ã™ï¼

ã€€![ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](/images/clean_arch.jpg)
ã€€*"The Clean Architecture" (https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html) ã‚ˆã‚Šå¼•ç”¨*

ã€€èª¬æ˜ã«ã¤ã„ã¦ã¯æ¬¡ã®ã‚µã‚¤ãƒˆãŒåˆ†ã‹ã‚Šã‚„ã™ã„ã¨æ€ã„ã¾ã™ï¼šhttps://nrslib.com/clean-architecture/

 ã€€è¦ç‚¹ã¨ã—ã¦ã¯ï¼Œã‚ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§åˆ¥ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã¨ãï¼Œå‘¼ã³å‡ºã—ã¦ã„ã‚‹å´ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹å´ã« **ä¾å­˜ã®çŸ¢å°ã‚’å‘ã‹ã‚ã›ã‚‹ã¨ï¼Œä¸€æ–¹å‘ã®ã¿ã«å‘ã‹ã£ã¦ã„ã‚‹** ã¨ã„ã†ãƒ«ãƒ¼ãƒ« (Dependency Rule) ã‚’å®ˆã£ã¦ã„ã‚‹ã‚‚ã®ã§ã™ï¼

 ã€€ã“ã†ã™ã‚‹ã¨ï¼ŒçŸ¢å°ãŒå‘ã‹ã£ã¦ã„ãã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ä¸­å¿ƒéƒ¨ã«ä½ç½®ã™ã‚‹ **ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ (Use Case) ã¯ï¼Œå‘¨ç¸éƒ¨ã«ã‚ã‚‹äº›æœ«ãªè©³ç´° (ã©ã“ã«å‡ºåŠ›ã™ã‚‹ã‹ãªã©) ã®ã“ã¨ã‚’çŸ¥ã‚‰ãšã«ï¼Œãã®å¤‰æ›´ã‹ã‚‰ä¿è­·ã•ã‚Œã‚‹ç‰¹æ¨©çš„ä½ç½®ã‚’ç²å¾—** ã—ã¾ã™ï¼Use Case ã¯ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚„è©³ç´°ã«ä¾å­˜ã—ãªã„ç´”ç²‹ãªå…¥å‡ºåŠ›ã‚’æŒã¤ã‚‚ã®ã¨ã—ã¦æƒ³å®šã—ã¦ã„ã¾ã™ï¼ãã‚Œã«åŠ ãˆã¦å‘¨ç¸éƒ¨ã®è©³ç´°ã‚’æŒ¿ã’æ›¿ãˆã‚‹ (å‘ãå…ˆã‚’ DB ã‹ã‚‰ In-memory ã«ã™ã‚‹ãªã©) ã“ã¨ã§ï¼Œãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ (testability) ã‚‚é«˜ã¾ã‚Šã¾ã™ï¼ã¾ãŸï¼Œè²¬å‹™ãŒåˆ†é›¢ã•ã‚Œã¦ã„ã‚‹ãŸã‚ï¼Œã©ã®å‡¦ç†ãŒã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ã‚‹ã‹ã‚ã‹ã‚Šã‚„ã™ã„ã¨ã„ã†ã®ã‚‚åˆ©ç‚¹ã§ã™ï¼

# Django REST framework ã§ã‚„ã‚‹
ã€€ã•ã¦ï¼Œãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®è²¬å‹™ã¨ã¯ãªã‚“ã§ã—ã‚‡ã†ã‹ï¼Ÿ 

1. HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ã¦ï¼Œ
2. é©åˆ‡ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚ã‚‹ã‹èªè¨¼ã—ï¼Œ
3. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã—ï¼Œ
4. æ°¸ç¶šåŒ–ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ç”¨ã„ã¦ä½•ã‹ã—ã‚‰ã®å‡¦ç†ã‚’ã—ã¦ï¼Œ
5. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™

ã€€ã™ãªã‚ã¡ï¼Œãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–ã¨ãã®ãƒ‡ãƒ¼ã‚¿ã®çŠ¶æ…‹ã‚’å–å¾—ãƒ»å¤‰æ›´ã™ã‚‹ã‚‚ã®ã ã¨æ€ã£ã¦ã„ã¾ã™ï¼

ã€€ä¸Šã® 4. ãŒ Use Case ã«ç›¸å½“ã—ã¾ã™ï¼ã¾ãŸï¼Œãã® Use Case ã¯æ°¸ç¶šåŒ–ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã«å¯¾å¿œã™ã‚‹ Entity ã«ä¾å­˜ã™ã‚‹ã®ã§ï¼Œ **Entity ãŒã‚‚ã£ã¨ã‚‚ä¸­æ ¸çš„ãªéƒ¨åˆ†** ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ï¼

ã€€ã¾ãŸï¼ŒUse Case ã®ç´”ç²‹ãªå…¥å‡ºåŠ›ã‚’ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆ â†’  ãƒ¬ã‚¹ãƒãƒ³ã‚¹ ã¨ã„ã†å¤–éƒ¨ã®å…¥å‡ºåŠ›é–¢ä¿‚ã«å¤‰æ›ã™ã‚‹å‘¨è¾ºéƒ¨åˆ†ã®è©³ç´° (4. ä»¥å¤–) ãŒ Controller ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ï¼

ã€€ã“ã‚Œã‚’ Djagno REST framework ã§å®Ÿç¾ã™ã‚‹æ–¹æ³•ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ï¼ãªãŠï¼Œå…¨ä½“çš„ã«ãƒ•ã‚¡ã‚¤ãƒ«åã¯ `[model name]_[model | view | serializer | use_case].py`ã€€ç­‰ã¨ã—ã¦ã„ã¾ã™ï¼

# Controller
## BaseViewSet
Djagno REST framework ã§ã„ã†ã¨ `View` ã§ã™ï¼`View` ã¯ã‚ã‚‹ URL ã®ãƒ‘ã‚¹ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ï¼Œ**ãã‚Œã«å¯¾ã™ã‚‹å„ HTTP ãƒ¡ã‚½ãƒƒãƒ‰ (`GET`, `POST`, `PUT`, `DELETE` ãªã©) ã«å¯¾ã™ã‚‹å‡¦ç†ã‚’ã¾ã¨ã‚ã¦è¨˜è¿°** ã—ã¾ã™ï¼

ã‚³ãƒ¼ãƒ‰ä¾‹ (ã‚¤ãƒ¡ãƒ¼ã‚¸)ï¼š
```py:urls.py
router = routers.SimpleRouter()

router.register(r'books', views.BookView, basename='books')

# URL å®šç¾©
urlpatterns = [
    path('', include(router.urls)),
]
```

ã“ã‚Œã«ã¯ï¼Œ`rest-framework.viewsets.GenericViewSet` ã‚’ç”¨ã„ã¾ã™ï¼

å„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã¾ã¨ã‚ã¦è¨˜è¿°ã™ã‚‹ã¨ã„ã† `View` ã®æ€§è³ªä¸Šï¼ŒUse Case ã‚’ã¯ã˜ã‚ã¨ã—ãŸã‚‚ã®ã‚’ **ã€Œã©ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«ã©ã‚Œã‚’ä½¿ã†ã‹ã€ãŒã§ãã‚‹ã ã‘åŠ¹ç‡çš„ã«è¨˜è¿°ã§ãã‚Œã°ã†ã‚Œã—ã„** ã§ã™ï¼ã¨ã„ã†ã®ã‚‚ï¼ŒDjango REST framework ã§ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã®å½¢çŠ¶ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨˜è¿°ã™ã‚‹ãŸã‚ã® `Serializer` ã¨ã„ã†ä»•çµ„ã¿ãŒã‚ã‚Šï¼Œãã‚Œã¯è¤‡æ•°ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§å…±é€šã‚ã‚‹ã„ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚‚ã®ã‚’æŒ‡å®šã—ãŸå ´åˆãŒå¤šã„ã¨æ€ã‚ã‚Œã‚‹ã‹ã‚‰ã§ã™ï¼

:::message alert
ã“ã‚Œã¯ä»Šå›ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«åˆã‚ã›ãŸéå¸¸ã«ç‰¹æ®Šãªã‚‚ã®ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ï¼
:::

```py:base_viewset.py
class BaseViewSet(viewsets.GenericViewSet):
    """
    ViewSet
    å„ã‚¯ãƒ©ã‚¹ dict ã«ã¦ã€action ã«å¯¾å¿œã—ãŸ serializer etcãŒå–å¾—ã§ãã‚‹

    serializer_class_dict = {
        'list': ListSerializer, # list æ™‚ã«å‹•ä½œ
        'retrieve': RetrieveSerializer, # retrieve æ™‚ã«å‹•ä½œ
        'default': GenericSerializer, # ä¸Šè¨˜ãã®ä»–ã§å–å¾—
    }

    action -> default -> list ã®é †ã§å–å¾—

    serializer_class_dict ã®ã¿ request, response Dict å¯èƒ½
    serializer_class_dict = {
        'default': {
            'request': RequestSerializer,
            'response': RequestSerializer,
        }
    }

    """

    # Open API
    TAG = []

    class Meta:
        abstract = True

    # Permissions
    permission_classes_dict: Dict[str, Tuple] = {}

    # Serializer
    serializer_class_dict: Dict[str, Union[Type[serializers.Serializer],
                                           Dict[str, Type[serializers.Serializer]]]] = {}

    # Alias
    serializer_alias_dict: Dict[str, str] = {
        'list': 'datas', 'default': 'data'}
    serializer_option_alias_dict: Dict[str, str] = {'default': 'options'}

    # UseCase
    use_case_dict: Dict[str, Type[BaseUseCase]] = {}

    # Filter
    filter_set_dict: Dict[str, Type[BaseFilterSet]] = {}
```

ã€€ãƒ¡ã‚½ãƒƒãƒ‰ (`action` ã¨ã—ã¦ï¼Œ`GET` â†’ `retrieve` or `list` ç­‰ã¨å¯¾å¿œã—ã¦ã„ã‚‹) ã«å¯¾å¿œã™ã‚‹ã‚‚ã®ã‚’ dict ã®å½¢ã§æŒ‡å®šã—ã¾ã™ï¼ã“ã“ã§ã¯ï¼Œãã®ã‚ˆã†ãªå½¢å¼ã§ `Permission`ï¼Œ`Serializer`ï¼Œ`Use Case`ï¼Œ`FilterSet` ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ï¼`FilterSet` ã¨ã¯ï¼Œã„ã‚ã‚†ã‚‹ã‚¯ã‚¨ãƒª (URL ã® `?` ä»¥é™ã®ã‚‚ã®) ã«å¯¾å¿œã—ã¾ã™ï¼

ã€€å®Ÿè£…ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ï¼š

```py:base_viewset.py
def get_serializer_request(self, *args, **kwargs):
    serializer_class = self.get_serializer_class('request')
    kwargs.setdefault('context', self.get_serializer_context())
    return serializer_class(*args, **kwargs)

def get_serializer_response(self, *args, **kwargs):
    serializer_class = self.get_serializer_class('response')
    kwargs.setdefault('context', self.get_serializer_context())
    return serializer_class(*args, **kwargs)

def get_serializer_alias(self) -> str:
    return (
        self.serializer_alias_dict.get(self.action) or
        self.serializer_alias_dict.get('default') or
        self.serializer_alias_dict['list']
    )

def get_serializer_option_alias(self) -> str:
    # main: default. If required, will add.
    return (
        self.serializer_option_alias_dict['default']
    )

def get_use_case(self, *args, **kwargs) -> Any:
    cls = (
        self.use_case_dict.get(self.action) or
        self.use_case_dict.get('default') or
        self.use_case_dict['list']
    )
    return cls(*args, **kwargs)  # type: ignore

def get_filter_set(self, request) -> BaseFilterSet:
    filter_set_class = self.get_filter_set_class()
    return filter_set_class(request)

def _get_serializer_class_from_action(self) -> Union[Type[serializers.Serializer], Dict[str, Type[serializers.Serializer]]]:
    return (
        self.serializer_class_dict.get(self.action) or
        self.serializer_class_dict.get('default') or
        self.serializer_class_dict['list']
    )

def get_serializer_class(self, type_: str = 'request') -> Type[serializers.Serializer]:
    """also required open api"""
    serializer_class_dict_value = self._get_serializer_class_from_action()

    if isinstance(serializer_class_dict_value, dict):
        return serializer_class_dict_value[RequestType[type_].name]
    else:
        return serializer_class_dict_value

def get_filter_set_class(self) -> Type[BaseFilterSet]:
    """also required for open api"""
    return (
        self.filter_set_dict.get(self.action) or
        self.filter_set_dict.get('default') or
        BlankFilterSet
    )
```
`self.action` ã«å¯¾å¿œã™ã‚‹ã‚‚ã®ãŒã‚ã‚Œã°ãã‚Œã‚’ï¼Œã©ã†ã§ãªã‘ã‚Œã° `default` ã‚’ã¨ã„ã†ã®ãŒåŸºæœ¬ã§ã™ï¼

## SingleViewSet
ã•ã¦ï¼Œã“ã‚Œã‚’ç¶™æ‰¿ã—ï¼ŒCRUD æ“ä½œã‚’è¡Œã† View ç”¨ã® `SingleViewSet` ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã† (æŠœç²‹)ï¼š

```py:single_viewset.py
def format_payload(alias: str, objs: Union[Any, Tuple]) -> Dict[str, Any]:
    return {alias: objs[0], 'extras': objs[1]} if isinstance(objs, tuple) else {alias: objs}

class SingleViewSet(BaseViewSet):
    """
    Single ViewSet
    """

    # LookUp
    lookup_field = 'id'

    def _list(self, request, *args, **kwargs) -> Response:
        alias = self.get_serializer_alias()
        case = self.get_use_case()
        filterset = self.get_filter_set(request)

        objs = case.execute(request.muser, filterset.data)

        payload = format_payload(alias, objs)

        serializer = self.get_serializer_response(payload)
        return Response(serializer.data)

    def _create(self, request, *args, **kwargs) -> Response:
        alias = self.get_serializer_alias()
        option_alias = self.get_serializer_option_alias()
        case = self.get_use_case()

        serializer = self.get_serializer_request(data=request.data)
        serializer.is_valid(raise_exception=True)

        obj = case.execute(request.muser,
                           serializer.validated_data[alias], serializer.validated_data.get(option_alias, {}))

        payload = format_payload(alias, obj)

        serializer = self.get_serializer_response(payload)
        return Response(serializer.data, status=status.HTTP_201_CREATED)
```
ä»–ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«ã¤ã„ã¦ã‚‚åŒæ§˜ã®å‡¦ç†ãŒç¶šãã¾ã™ï¼ã¾ãš `_list` (`GET`) ã‚’è¦‹ã¾ã—ã‚‡ã†ï¼ã¯ã˜ã‚ã« `get_serializer_alias` ã§ `alias` ã‚’å–å¾—ã—ã¦ã„ã¾ã™ï¼`alias` ã¨ã¯ï¼ŒJSON ã®æœ€ä¸Šä½ã®ã‚­ãƒ¼ã®ã“ã¨ã§ï¼Œãƒ‡ãƒ¼ã‚¿ã¯ä¸€éšå±¤æ·±ã„ã¨ã“ã‚ã«å…¥ã‚Œã¦ã„ã¾ã™ï¼ä¾‹ãˆã°ï¼Œä»¥ä¸‹ã®ä¾‹ã§ã„ã†ã¨ `data` ãŒ `alias` ã«ãªã‚Šã¾ã™ï¼

```py
{
    'data': {
        'id': 'xxx',
        'name': 'xxx',
    }
}
```

å˜æ•°ã®å ´åˆã¯ `data`ï¼Œè¤‡æ•° (ãƒªã‚¹ãƒˆ) ã®å ´åˆã¯ `datas`ï¼Œãã—ã¦åŒã˜éšå±¤ã« (`count` ãªã©) è£œè¶³ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚ŒãŸã„å ´åˆã¯ `extras` ã¨ã„ã† `alias` ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ï¼

ã€€ãã®å¾Œï¼Œå¯¾å¿œã™ã‚‹ `FilterSet` ã¨ `Use Case` ã‚’å–å¾—ã—ï¼Œ`Use Case` ã‚’å®Ÿè¡Œã—ï¼Œå¯¾å¿œã™ã‚‹ `Response Serializer` ã«æ¸¡ã—ã¦è¿”ã™ã¨è¨€ã†æµã‚Œã§ã™ï¼`_create` (`POST`) ã®å ´åˆã¯ï¼Œ`Use Case` ã«æ¸¡ã™å‰ã« `Request Serializer` ã«ã‚ˆã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå…¥ã‚Šã¾ã™ï¼`Serializer` ã¯ãƒ¢ãƒ‡ãƒ«ã® `save` ç­‰ã‚‚ã§ãã¾ã™ãŒï¼Œä»Šå›ã¯ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿å½¢çŠ¶ã®æ˜ç¤ºã®ã¿ã«ä½¿ã†ã“ã¨ã¨ã—ã¾ã™ï¼

# Use Case
`Use Case` ã¯ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ `execute` ã‚’æŒã¤ã‚¯ãƒ©ã‚¹ã§ã™ï¼š

```py:use_case.py
class BaseUseCase(ABC):

    main_class: models.Model

    @abstractmethod
    def execute(self, *args, **kwargs):
        """
        create a running function
        """
```

ä¾‹ãˆã°ï¼Œè‡ªèº«ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¿”ã™ `/me` ã¯æ¬¡ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¾ã™ï¼š

```py:get_me.py
class GetMe(BaseUseCase):

    muser_class = MUser

    def execute(self, muser: MUser):

        return muser
```

å¼•æ•°ã«ã¯ï¼Œãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ï¼ŒãŠã‚ˆã³ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã£ã¦ã¯ `FilterSet` ãŒæ¸¡ã•ã‚Œï¼Œã‚¯ã‚¨ãƒªãŒå–å¾—ã§ãã¾ã™ï¼

ã€€é›£ç‚¹ã¨ã—ã¦ã¯ï¼Œãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã”ã¨ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹ãŸã‚ï¼Œãƒ•ã‚¡ã‚¤ãƒ«æ•°ãŒè«å¤§ã«ãªã‚‹ã¨ã„ã†ã“ã¨ã§ã™ï¼ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã®ãƒ•ã‚¡ã‚¤ãƒ«åæ¤œç´¢ã§ã‚ã‚‹ç¨‹åº¦ä¸ä¾¿ã‚’ç·©å’Œã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼

# Logics
ä¸€èˆ¬ã«è²¬å‹™ã®åˆ†é›¢ã®è¦³ç‚¹ã‹ã‚‰ï¼Œã‚ã‚‹é–¢æ•°ãŒæ‹…ã†å½¹å‰²ã¯ã§ãã‚‹ã ã‘ç‹­ã„æ–¹ãŒå†åˆ©ç”¨æ€§ç­‰ãŒé«˜ã¾ã‚‹ãŸã‚è‰¯ã„ã¨è€ƒãˆã‚‰ã‚Œã¦ã„ã¾ã™ï¼ã™ãªã‚ã¡ï¼Œå‡é›†åº¦ã‚’é«˜ãã—ãŸæ–¹ãŒè‰¯ã„ã§ã™ï¼ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãŒè¤‡é›‘ã«ãªã‚Šï¼Œ`Use Case` ãŒè‚¥å¤§åŒ–ã—ãã†ãªéš›ã«ã¯ï¼Œå®Ÿè£…ã‚’ (å ´åˆã«ã‚ˆã£ã¦ã¯è¤‡æ•°ã®) ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ã‚¯ãƒ©ã‚¹ã«åˆ†ã‘ã¦å®šç¾©ã—ï¼Œãã®ãƒ¡ã‚½ãƒƒãƒ‰ã®ç¾…åˆ—ã«ã‚ˆã£ã¦å‡¦ç†ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’æ˜ç­ã«ç¤ºã—ãŸæ–¹ãŒè‰¯ã„ã¨æ€ã‚ã‚Œã¾ã™ï¼ã™ãªã‚ã¡ï¼Œæ™‚é–“çš„ / æ‰‹ç¶šãçš„å‡é›†ã‚’è§£æ¶ˆã—ã¾ã™ï¼ãã®éš›ã« `logics` ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’åˆ‡ã‚Šã¾ã™ï¼

:::message alert
ã“ã‚Œã‚‚ä¸€èˆ¬çš„ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‹ã‚‰é€¸è„±ã—ã¦ãŠã‚Šè­°è«–ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™ï¼
:::

ä¾‹ãˆã°ï¼Œä»¥ä¸‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```py:list_mgadget.py
class ListMGadget(BaseUseCase):

    mgadget_class = MGadget

    def execute(self, muser: MUser, filterset_data: Dict[str, Any]):
    
        page = filterset_data.get('page')
        page_size = filterset_data.get('page_size')
        keyword = filterset_data.get('keyword')
        sort_key = filterset_data.get('sort_key', 'total_results')
        sort_order = filterset_data.get('sort_order', False)

        mgadget_queryset = (
            self.mgadget_class.objects
                .all()
        )

        mgadget_process = MGadgetProcess(mgadget_queryset)
        mgadget_process.filter_or_query_param(keyword)
        
        if keyword is None:
            mgadget_process.sort_by_query_param(sort_key, sort_order)

        mgadget_process.distinct()
        mgadget_process.paginate(page_size, page)

        mgadget_queryset = mgadget_process.mgadget_queryset
        
        count = len(list(mgadget_queryset))

        return mgadget_queryset, {'count': count}
```

ã“ã“ã§ã¯ `keyword` ã«ã‚ˆã‚‹æ¤œç´¢ã‚„ï¼Œã‚½ãƒ¼ãƒˆï¼Œãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ç­‰ã‚’è¡Œã„ã¾ã™ãŒï¼Œã“ã‚Œã‚‰ã‚’ `MGadgetProcess` ã«å®šç¾©ã•ã‚ŒãŸå„ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§è¡Œã„ã¾ã™ï¼ãƒ¡ã‚½ãƒƒãƒ‰ã«ã¯ä½•ã‚’è¡Œã†ã‹ãŒæ˜ç­ã«ã‚ã‹ã‚‹ã‚ˆã†ãªå‘½åãŒãªã•ã‚Œã¦ãŠã‚Šï¼Œé•·ããªã‚ŠãŒã¡ãªå®Ÿè£…ã¯ `/logics` ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«éš è”½ã•ã‚Œã¦ã„ã¾ã™ï¼ã“ã‚Œã«ã‚ˆã‚Šï¼Œãƒ¡ã‚½ãƒƒãƒ‰åã®ç¾…åˆ—ã«ã‚ˆã£ã¦æ¬¡ã®ã‚ˆã†ãªå‡¦ç†ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãŒæ˜ç­ã«ãªã£ã¦ã„ã¾ã™ï¼š

1. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿
2. ã‚­ãƒ¼ã«ã‚ˆã‚‹ã‚½ãƒ¼ãƒˆ
3. é‡è¤‡ã‚’é™¤ã
4. ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³

ã¾ãŸï¼Œå„ãƒ¡ã‚½ãƒƒãƒ‰å†…ã« `None` ã‚„å‹ã®ãƒã‚§ãƒƒã‚¯ãªã©ã‚’éš è”½ã§ãã¾ã™ï¼š

```py:mgadget_process.py
@dataclass
class MGadgetProcess:
    
    mgadget_queryset: MGadgetQuerySet

    def filter_or_query_param(self, keyword):
        if keyword is not None:

            self.mgadget_queryset = (
                self.mgadget_queryset.filter_or_keyword(keyword)
            )

    def sort_by_query_param(self, sort_key, sort_order):
        if sort_key is not None:
            self.mgadget_queryset = (
                self.mgadget_queryset.sort_by_key(sort_key, sort_order)
            )

    def count(self):
        return self.mgadget_queryset.count()

    def paginate(self, page_size, page):
        if isinstance(page_size, int) and isinstance(page, int):
            self.mgadget_queryset = self.mgadget_queryset.paginate(page_size, page)

    def distinct(self):
        self.mgadget_queryset = self.mgadget_queryset.distinct()
```

# Entity (QuerySet)
Entity ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ï¼š

```py:mbook_model.py
class MBookQuerySet(QuerySet):

    def get_by_id(self, id_: str) -> Optional['MBook']:
        try:
            return self.get(id=id_)
        except MBook.DoesNotExist:
            return None

    def filter_id_in(self, id_list: List[str]) -> 'MBookQuerySet':
        return self.filter(id__in=id_list)

    def filter_eq_id(self, id_: str) -> 'MBookQuerySet':
        return self.filter(id=id_)


class MBook(BaseModel):
    '''
    æ²è¼‰å˜è¡Œæœ¬
    '''
    
    series = models.CharField(
        max_length=8192,
        choices=BookSeriesEnum.choices()
    )
    volume = models.CharField(max_length=8192)
    mgadgets = models.ManyToManyField(
        'dorapi.MGadget',
        related_name='mgadgets',
        related_query_name='mgadget',
        through='dorapi.GadgetBook',
    )

    objects = MBookQuerySet.as_soft_manager()
    object_all = MBookQuerySet.as_manager()
```

ã€€Django Model ã¨ `QuerySet` ã‚’ä¸€ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã¦ã„ã¾ã™ï¼åŸºæœ¬çš„ã«ï¼ŒORM ã«ã‚ˆã‚‹å‡¦ç†ã¯ `MBookQuerySet` ã§å®šç¾©ã•ã‚ŒãŸãƒ¡ã‚½ãƒƒãƒ‰ã ã‘ã‚’ç”¨ã„ã¦è¡Œã„ã¾ã™ (å¿…è¦ãªå‡¦ç†ãŒã‚ã‚Œã°éƒ½åº¦æ›¸ãè¶³ã—ã¦ã„ã)ï¼QuerySet ã®æ„å‘³ãŒå‘½åã«ã‚ˆã‚Šæ˜ç¤ºã§ãã‚‹ä¸Šã«ï¼Œ`get` ç­‰å­˜åœ¨ã—ãªã„ã“ã¨ãŒã‚ã‚Šã†ã‚‹å ´åˆã®ä¾‹å¤–å‡¦ç†ã‚‚éš è”½ã§ãã¾ã™ï¼

ã€€ãªãŠï¼Œã“ã“ã§ã® `QuerySet` ã¯å¾“æ¥ã® Django ã® `QuerySet` ã‚’æ‹¡å¼µã—ãŸã‚‚ã®ã§ã™ï¼š

```py:queryset.py
from django.db import models
from datetime import datetime


class QuerySet(models.QuerySet):

    def as_soft_manager(cls):
        from .manager import SoftManager
        manager = SoftManager.from_queryset(cls)()
        manager._built_with_as_manager = True
        return manager

    as_soft_manager.queryset_only = True
    as_soft_manager = classmethod(as_soft_manager)  # type: ignore

    def delete(self):
        deleted_at = datetime.now()
        objs = list(self)
        for obj in objs:
            obj.deleted_at = deleted_at

        self.bulk_update(objs, ['deleted_at'])
        return objs
```

`delete` ã«é–¢ã—ã¦ã¯å®Ÿéš›ã«å‰Šé™¤ã™ã‚‹ã®ã§ã¯ãªãï¼Œ`deleted_at` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°ã—è«–ç†å‰Šé™¤ã¨ã—ã¦ã„ã¾ã™ï¼š

```py:manager.py
class SoftManager(models.Manager):

    def get_queryset(self):
        return self._queryset_class(model=self.model, using=self._db, hints=self._hints).filter(deleted_at=None)
```

`BaseModel` ã§ã‚‚åŒæ§˜ã§ã™ï¼š

```py:base_model.py
from datetime import datetime
import uuid

from django.db import models


class BaseModel(models.Model):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    create_date = models.DateTimeField(auto_now_add=True)
    update_date = models.DateTimeField(auto_now=True)
    deleted_at = models.DateTimeField(default=None, null=True, blank=True)

    class Meta:
        abstract = True

    def delete(self):
        self.deleted_at = datetime.now()
        self.save()

    def hard_delete(self):
        super().delete()

```

# å¾“æ¥ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ã®ç›¸é•ç‚¹
å¾“æ¥ã®ã‚‚ã®ã¨ã®ç›¸é•ç‚¹ã¯ä»¥ä¸‹ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ï¼

1. `/logics` ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ä½œã£ã¦ã„ã‚‹
2. `QuerySet` ã‚’ `Repository` åŒ–ã—ã¦ã„ãªã„
3. `View` ã¨ `Use Case` ã®ã‚„ã‚Šå–ã‚Šã®éš›ã« `interface` ã‚’ç”¨ã„ãŸæŠ½è±¡åŒ–ã‚„ `dataclass` ç­‰ã§ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®æ˜ç¤ºãŒè¡Œã‚ã‚Œã¦ã„ãªã„
4. `ViewSet` ã®ä½¿ã„æ–¹ãŒç‰¹æ®Š

`Repository` ã§ã¯ãªã ORM ã‚’ä½¿ã£ã¦ã„ã‚‹ç†ç”±ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã‚’å‚è€ƒã«ã—ã¦ã„ã‚‹ãã†ã§ã™ï¼šhttps://hamidmosalla.com/2018/11/25/stop-using-repository-pattern-with-an-orm/#:~:text=Repository%20Pattern%20Helps%20Hide%20SQL%20Complexity&text=Now%20when%20using%20ORM%20the,doesn't%20make%20any%20sense.

# ãŠã‚ã‚Šã«
Django REST framework ã«ã‚ˆã‚‹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å®Ÿè·µä¾‹ã¯è³‡æ–™ãŒå°‘ãªãï¼Œã¾ãŸè‡ªåˆ†è‡ªèº«éå¸¸ã«å­¦ã³ã®å¤šã„ã‚³ãƒ¼ãƒ‰ã ã£ãŸãŸã‚ï¼Œãã®æ¦‚è¦ã‚’è¨˜äº‹ã«æ®‹ã—ã¦ãŠããŸã„ã¨æ€ã£ãŸæ¬¡ç¬¬ã§ã™ï¼ã”æ„è¦‹ç­‰ã„ãŸã ã‘ã‚Œã°ã†ã‚Œã—ãæ€ã„ã¾ã™ï¼
