---
title: "前職での学び #1　─Django でクリーンアーキテクチャ─"
emoji: "📝"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["python", "cleanarchitecture", "djangorestframework", "クリーンアーキテクチャ", "アーキテクチャ"]
published: false
---

# はじめに
　前職での経験を踏まえて，Django REST framework でクリーンアーキテクチャのサンプルを試しに実装してみたので，今回はそれについて紹介したいと思います．初めての技術記事投稿なので，至らないところがあればご指摘いただければ幸いです．

:::message
サンプルコードは以下がありますので，詳細が知りたい方はそちらも合わせてご参照ください．
　
https://github.com/asSqr/django_clean_arch
:::

# クリーンアーキテクチャとは
　さて，クリーンアーキテクチャとは何でしょうか？ よく引用されるのは次図です．

　![クリーンアーキテクチャ](/images/clean_arch.jpg)
　*"The Clean Architecture" (https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html) より引用*

　説明については次のサイトが分かりやすいと思います：https://nrslib.com/clean-architecture/

 　要点としては，あるモジュールで別のモジュールを呼び出しているとき，呼び出している側から呼び出されている側に **依存の矢印を向かわせると，一方向のみに向かっている** というルール (Dependency Rule) を守っているものです．

 　こうすると，矢印が向かっていくアーキテクチャの中心部に位置する **ビジネスロジック (Use Case) は，周縁部にある些末な詳細 (どこに出力するかなど) のことを知らずに，その変更から保護される特権的位置を獲得** します．Use Case はフレームワークや詳細に依存しない純粋な入出力を持つものとして想定しています．それに加えて周縁部の詳細を挿げ替える (向き先を DB から In-memory にするなど) ことで，テスト容易性 (testability) も高まります．また，責務が分離されているため，どの処理がどのファイルにあるかわかりやすいというのも利点です．

# Django REST framework でやる
　さて，バックエンドの責務とはなんでしょうか？ 

1. HTTP リクエストを受けて，
2. 適切なユーザーであるか認証し，
3. リクエストボディのバリデーションをし，
4. 永続化されているデータを用いて何かしらの処理をして，
5. レスポンスボディとしてデータを返す

　すなわち，データの永続化とそのデータの状態を取得・変更するものだと思っています．

　上の 4. が Use Case に相当します．また，その Use Case は永続化されているデータに対応する Entity に依存するので， **Entity がもっとも中核的な部分** ということになります．

　また，Use Case の純粋な入出力を HTTP リクエスト →  レスポンス という外部の入出力関係に変換する周辺部分の詳細 (4. 以外) が Controller ということになります．

　これを Djagno REST framework で実現する方法を見ていきましょう．なお，全体的にファイル名は `[model name]_[model | view | serializer | use_case].py`　等としています．

# Controller
## BaseViewSet
Djagno REST framework でいうと `View` です．`View` はある URL のパスに割り当てられて，**それに対する各 HTTP メソッド (`GET`, `POST`, `PUT`, `DELETE` など) に対する処理をまとめて記述** します．

コード例 (イメージ)：
```py:urls.py
router = routers.SimpleRouter()

router.register(r'books', views.BookView, basename='books')

# URL 定義
urlpatterns = [
    path('', include(router.urls)),
]
```

# おわりに
Django REST framework によるクリーンアーキテクチャの実践例は資料が少なく，また自分自身非常に学びの多いコードだったため，その概要を記事に残しておきたいと思った次第です．ご意見等いただければうれしく思います．
